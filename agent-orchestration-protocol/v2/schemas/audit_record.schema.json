{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aop.v2/schemas/audit_record.schema.json",
  "title": "AuditRecord",
  "description": "Structured audit trail record for AOP v2.0.2-C. Captures all orchestration events for governance and compliance.",
  "type": "object",
  "required": [
    "audit_record_id",
    "audit_version",
    "timestamp",
    "session_id",
    "task_id",
    "record_type",
    "actor",
    "payload",
    "context",
    "governance"
  ],
  "additionalProperties": false,
  "properties": {
    "audit_record_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this audit record (UUID v4)"
    },
    "audit_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Version of the audit schema"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 UTC timestamp of when the event occurred"
    },
    "session_id": {
      "type": "string",
      "minLength": 1,
      "description": "Session identifier this record belongs to"
    },
    "task_id": {
      "type": "string",
      "minLength": 1,
      "description": "Task identifier this record is associated with"
    },
    "record_type": {
      "type": "string",
      "enum": [
        "TASK_DISPATCHED",
        "RESPONSE_RECEIVED",
        "ROUTING_DECISION",
        "GUARD_RAIL_CHECK",
        "ROLLBACK_EVENT",
        "SESSION_SUMMARY"
      ],
      "description": "Type of audit event recorded"
    },
    "actor": {
      "type": "object",
      "required": ["name", "role"],
      "additionalProperties": false,
      "description": "The agent or system component that performed this action",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Agent name or system component identifier (e.g., 'Orchestrator', 'Magneto')"
        },
        "role": {
          "type": "string",
          "enum": ["ORCHESTRATOR", "EXECUTOR", "ROUTER", "GOVERNANCE"],
          "description": "Role of the actor in the orchestration"
        },
        "provider": {
          "type": ["string", "null"],
          "description": "LLM provider (e.g., CLAUDE, CODEX, GEMINI)"
        },
        "model": {
          "type": ["string", "null"],
          "description": "Model identifier used by this actor"
        }
      }
    },
    "payload": {
      "type": "object",
      "description": "Event-specific data. Schema varies by record_type.",
      "oneOf": [
        {
          "title": "TASK_DISPATCHED payload",
          "description": "Full OrchestrationEnvelope JSON serialized",
          "required": ["message_type", "session", "target", "task"],
          "properties": {
            "message_type": {"type": "string", "const": "TASK"}
          }
        },
        {
          "title": "RESPONSE_RECEIVED payload",
          "description": "Full ExecutorResponse JSON serialized",
          "required": ["message_type", "session_id", "task_id", "agent", "task_status"],
          "properties": {
            "message_type": {"type": "string", "const": "RESPONSE"}
          }
        },
        {
          "title": "ROUTING_DECISION payload",
          "required": ["input_version", "routed_to", "model_selected", "fallback_triggered"],
          "properties": {
            "input_version": {"type": "string", "enum": ["V2", "V1", "UNSTRUCTURED"]},
            "routed_to": {"type": "string"},
            "model_selected": {"type": "string"},
            "fallback_triggered": {"type": "boolean"},
            "fallback_reason": {"type": ["string", "null"]},
            "alternatives_tried": {"type": "array", "items": {"type": "string"}}
          }
        },
        {
          "title": "GUARD_RAIL_CHECK payload",
          "required": ["check_type", "result", "details"],
          "properties": {
            "check_type": {
              "type": "string",
              "enum": ["PAYLOAD_LIMIT", "BUDGET", "TIMEOUT", "ACCESS", "FINAL_SIGNAL", "MINIMAL_REPORT"]
            },
            "result": {"type": "string", "enum": ["PASS", "WARN", "FAIL"]},
            "details": {"type": "string"},
            "error_code": {"type": ["string", "null"]}
          }
        },
        {
          "title": "ROLLBACK_EVENT payload",
          "required": ["trigger", "artifacts_rolled_back", "status"],
          "properties": {
            "trigger": {"type": "string"},
            "artifacts_rolled_back": {"type": "array", "items": {"type": "object"}},
            "status": {"type": "string", "enum": ["SUCCESS", "FAILED"]}
          }
        },
        {
          "title": "SESSION_SUMMARY payload",
          "required": ["total_tasks", "completed", "failed", "total_cost_usd", "total_duration_seconds"],
          "properties": {
            "total_tasks": {"type": "integer", "minimum": 0},
            "completed": {"type": "integer", "minimum": 0},
            "failed": {"type": "integer", "minimum": 0},
            "total_cost_usd": {"type": "number", "minimum": 0},
            "total_duration_seconds": {"type": "number", "minimum": 0},
            "agents_used": {"type": "array", "items": {"type": "string"}},
            "role_assignments": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["agent", "role"],
                "properties": {
                  "agent": {"type": "string"},
                  "role": {"type": "string"}
                }
              }
            }
          }
        }
      ]
    },
    "context": {
      "type": "object",
      "required": ["attempt", "correlation_id"],
      "additionalProperties": false,
      "description": "Execution context for this record",
      "properties": {
        "parent_task_id": {
          "type": ["string", "null"],
          "description": "Parent task ID for delegated tasks"
        },
        "attempt": {
          "type": "integer",
          "minimum": 1,
          "description": "Attempt number for this task"
        },
        "correlation_id": {
          "type": "string",
          "minLength": 1,
          "description": "Correlation ID for grouping records (typically session_id)"
        }
      }
    },
    "governance": {
      "type": "object",
      "required": ["guard_rails_applied", "access_decision"],
      "additionalProperties": false,
      "description": "Governance metadata for this record",
      "properties": {
        "guard_rails_applied": {
          "type": "array",
          "items": {"type": "string"},
          "description": "List of guard rail names checked for this event"
        },
        "budget_status": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "description": "Budget tracking status at time of record",
          "properties": {
            "max_cost_usd": {
              "type": ["number", "null"],
              "description": "Maximum allowed cost in USD (null if unlimited)"
            },
            "current_cost_usd": {
              "type": "number",
              "minimum": 0,
              "description": "Current accumulated cost in USD"
            },
            "within_budget": {
              "type": "boolean",
              "description": "Whether current cost is within budget"
            }
          },
          "required": ["current_cost_usd", "within_budget"]
        },
        "access_decision": {
          "type": "string",
          "enum": ["ALLOWED", "DENIED", "N/A"],
          "description": "Access control decision for this event"
        },
        "reason_code": {
          "type": ["string", "null"],
          "description": "E_* error code if access was denied or event failed"
        }
      }
    }
  },
  "examples": [
    {
      "audit_record_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "audit_version": "1.0.0",
      "timestamp": "2026-03-01T12:00:00Z",
      "session_id": "AOP-SESSION-001",
      "task_id": "TASK-001",
      "record_type": "GUARD_RAIL_CHECK",
      "actor": {
        "name": "Orchestrator",
        "role": "GOVERNANCE",
        "provider": null,
        "model": null
      },
      "payload": {
        "check_type": "PAYLOAD_LIMIT",
        "result": "PASS",
        "details": "Payload 1.2KB within 200KB limit",
        "error_code": null
      },
      "context": {
        "parent_task_id": null,
        "attempt": 1,
        "correlation_id": "AOP-SESSION-001"
      },
      "governance": {
        "guard_rails_applied": ["PAYLOAD_LIMIT"],
        "budget_status": {
          "max_cost_usd": 5.0,
          "current_cost_usd": 0.0,
          "within_budget": true
        },
        "access_decision": "ALLOWED",
        "reason_code": null
      }
    }
  ]
}
